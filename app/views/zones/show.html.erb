<% @switch_state_changed = false %>
<% @dimmer_state_changed = false %>
<script src="https://cdn.firebase.com/js/client/1.1.3/firebase.js"></script>

 <style>
.dummy {
    margin-top: 100%;
}
.tile {
    vertical-align: middle;
}
.thumbnail {
    position: absolute;
    top: 15px;
    bottom: 0;
    left: 15px;
    right: 0;
    
    text-align: center;
    padding-top:calc(24% - 34px);
}
.handle {
  font-size: 12px;
  color: #777;
  cursor: move;
   height: 20%;
}
.device-wrapper{

  height: 50%;
  margin: auto;
  padding-top: 5%;
  
}
.temp {
  width:  45%;
  height: 50%;
  margin: auto;
  font-size: 120%;
  padding-top: 5%;


}


.device-footer{
  margin: auto;
  height: 40%;
}
.placeholder {
    left: 5px;
    top: 15px;
    height: 140px;
    border: 1px solid grey;
    background-color: white;
    -webkit-box-shadow: 0px 0px 10px #888;
    -moz-box-shadow: 0px 0px 10px #888;
    box-shadow: 0px 0px 10px #888;
}
.placeholder:after {
            position: absolute;
            z-index: 10;
            content: " ";
            height: 120px;
            background: #f9f9f9;
            left: 0;
            right: 0;
}
.real-first-child {
    margin-left:0 !important;
}
.ui-slider-style { 

    margin-top: 5%;
    margin-left: 10%;
    width: 80%;
}

.switcher{
   
}

.widget-title {
    height: 22%;
}

.ui-slider-success { 
    margin-top: 5%;
    margin-left: 10%;
    width: 80%;
}

.temp {
  width:  40%;
  height: 45%;
  margin: auto;
  font-size: 120%;
  padding-top: 10%;


}


.motion-active {
  background-color: #00CC66;
  color: white;
}

.door-closed {
  background-color: #00CC66;
  color: white;
}

.door-open {
  background-color: #FF6600;
  color: white;
}

.door-locked {
  background-color: #00CC66;
  color: white;
}

.door-unlocked {
  background-color: #FF6600;
  color: white;
}

.btn-circle.btn-xl.temp-button {
  font-size: 18px !important;
}




</style>

           

    <div class="row grid" data-update-url='<%= sort_location_zones_url(@location) %>'>
    
     <% @things.each do |thing| %>
                      <% if thing.zone_id != nil %>
                        <% if thing.device_type == "dimmer" %>
                          <%= render partial: "tiles/dimmer", locals: {dimmer: thing}%>
                        <% elsif thing.device_type == "switch" %>
                          <%= render partial: "tiles/switch", locals: {switch: thing}%>
                        <% elsif thing.device_type == "lock" %>
                          <%= render partial: "tiles/lock", locals: {lock: thing}%>
                        <% elsif thing.device_type == "temperatureMeasurement" %>
                          <%= render partial: "tiles/temperature", locals: {temp: thing}%>
                        <% elsif thing.device_type == "relativeHumidityMeasurement" %>
                          <%= render partial: "tiles/humidity", locals: {humidity: thing}%>
                        <% elsif thing.device_type == "motion" %>
                          <%= render partial: "tiles/motion", locals: {motion: thing}%>
                        <% elsif thing.device_type == "contact" %>
                          <%= render partial: "tiles/contact", locals: {contact: thing}%>
                        <% elsif thing.device_type == "battery" %>
                          <%= render partial: "tiles/battery", locals: {battery: thing}%>
                        <% elsif thing.device_type == "illuminant" %>
                          <%= render partial: "tiles/illuminant", locals: {illuminant: thing}%>
                        <% elsif thing.device_type == "power" %>
                          <%= render partial: "tiles/power", locals: {power: thing}%>
                        <% elsif thing.device_type == "energy" %>
                          <%= render partial: "tiles/energy", locals: {energy: thing}%>
                        <% elsif thing.device_type == "presence" %>
                          <%= render partial: "tiles/presence", locals: {presence: thing}%>
                        <% end %>
                      <% end %>
                    <% end %>  
    </div>



<script>
$(function () {
    $(".grid").sortable({
        tolerance: 'pointer',
        revert: 'invalid',
        placeholder: 'col-md-2 col-sm-4 col-xs-6 placeholder tile',
        helper: 'clone',
        appendTo: 'body',
        handle: ".handle",
        forceHelperSize: true,
        
        start: function(event, ui) {
            $('.row-fluid > div.tile:visible:first').addClass('real-first-child');
        }, 
        stop: function(event, ui) {
            $('.row-fluid > div.real-first-child').removeClass('real-first-child');
        },
        change: function(event, ui) {
            $('.row-fluid > div.real-first-child').removeClass('real-first-child');
            $('.row-fluid > div.tile:visible:first').addClass('real-first-child');
        },
        update: function( event, ui ) {
           var sorted = $(".grid").sortable( "serialize");
           console.log(sorted)
           $.post($(this).data('update-url'), sorted)
        }
    });
});



   
</script>

<script>
    $('.toggle').on('click',function() {

          var form = $(this).parents('form:first');

         
          form.submit();
         
              
    });
</script>


<% @zone.things.each do |thing| %>
<script>
 
   <% if thing.device_type == "switch" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("<%= ENV["FIREBASE_URL"] %>/events/<%= thing.uid %>/switch");
    <% elsif thing.device_type == "dimmer" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("<%= ENV["FIREBASE_URL"] %>/events/<%= thing.uid %>/level");
    <% elsif thing.device_type == "temperatureMeasurement" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("<%= ENV["FIREBASE_URL"] %>/events/<%= thing.uid %>/temperature");
    <% elsif thing.device_type == "relativeHumidityMeasurement" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("<%= ENV["FIREBASE_URL"] %>/events/<%= thing.uid %>/humidity");
    <% elsif thing.device_type == "motion" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("<%= ENV["FIREBASE_URL"] %>/events/<%= thing.uid %>/motion");
    <% elsif thing.device_type == "contact" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("<%= ENV["FIREBASE_URL"] %>/events/<%= thing.uid %>/contact");
    <% elsif thing.device_type == "illuminant" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("<%= ENV["FIREBASE_URL"] %>/events/<%= thing.uid %>/illuminance");
    <% elsif thing.device_type == "battery" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("<%= ENV["FIREBASE_URL"] %>/events/<%= thing.uid %>/battery");
    <% elsif thing.device_type == "lock" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("<%= ENV["FIREBASE_URL"] %>/events/<%= thing.uid %>/lock");
    <% elsif thing.device_type == "power" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("<%= ENV["FIREBASE_URL"] %>/events/<%= thing.uid %>/power");
    <% elsif thing.device_type == "energy" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("<%= ENV["FIREBASE_URL"] %>/events/<%= thing.uid %>/energy");
    <% elsif thing.device_type == "presence" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("<%= ENV["FIREBASE_URL"] %>/events/<%= thing.uid %>/presence");
    <% end %>



    var query_<%=thing.id %> = myFirebaseRef_<%=thing.id %>.endAt().limit(1);
    query_<%=thing.id %>.on('child_added', function(snapshot) {
        var value = snapshot.val()
            if (value.name == "switch"){
                     $('.switch_'+value.device).bootstrapToggle(value.value)
                     console.log("changed switch value")
                     
            
                
            }

            if (value.name == "level"){
                var levelValue = $('.dimmer_'+value.device).slider("value")
                if (value.value != levelValue){
                     $('.dimmer_'+value.device).slider("value", value.value)
                }
               
               
            }
            if (value.name == "motion"){
              $('.motion_'+value.device).html(value.value);

                if(value.value == "active"){
                  $('.motion_'+value.device).addClass("motion-"+value.value);
                }else{
                   $('.motion_'+value.device).removeClass("motion-active");
                }
              

            }
            if (value.name == "contact"){
            
              if(value.value == "open"){
                  $('#contact_'+value.device).html("<button type='button' class='btn btn-warning btn-circle btn-xl'><i class='fa fa-times'></i></button>");
                 
                }else{
                  $('#contact_'+value.device).html("<button type='button' class='btn btn-success btn-circle btn-xl'><i class='fa fa-check'></i></button>");
                }

            }

            if (value.name == "lock"){
              $('.lock_'+value.device).html(value.value);
              if(value.value == "unlocked"){
                  $('.lock_'+value.device).removeClass("door-locked");
                  $('.lock_'+value.device).addClass("door-"+value.value);
                }else{
                   $('.lock_'+value.device).removeClass("door-unlocked");
                   $('.lock_'+value.device).addClass("door-"+value.value);
                }

            }

            if (value.name == "illuminance"){
              $('.illuminant_'+value.device).html(value.value+ " Lux");

            }

             if (value.name == "battery"){
              $('.battery_'+value.device).html(value.value+ " %");

            }

             if (value.name == "energy"){
              $('.energy_'+value.device).html(value.value+ " kWh");

            }

            if (value.name == "presence"){
              $('.presence_'+value.device).html(value.value);

            }

            if (value.name == "power"){
              
                if(value.unit == undefined){
                 var display_unit = "watts"
                  
                }else{
                 var display_unit = value.unit 
                }

                $('.power_'+value.device).html(value.value+ " "+display_unit);

            }

            if (value.name == "temperature"){
              if(value.unit == undefined){
                   var display_unit = "F"
                  
                }else{
                 var display_unit = value.unit 
                }
                $('.temperature_'+value.device).html("<button type='button' class='btn btn-success btn-circle btn-xl disabled temp-button'>"+value.value+"</br>"+display_unit+"</button>");

            }

            if (value.name == "humidity"){
              $('.humidity_'+value.device).html(value.value+" %");

            }
           
        console.log(value.device+' '+value.value);
        
    });
</script>
<% end %>


<script>
    $('.switch_class').click(function() {

          var form = $(this).parents('form:first');

         
          form.submit();
         
              
    });
</script>


<script>

<% @things.where(:device_type => "dimmer").each do |dimmer| %>


var colorful_sliders_options = {
    'range': 'min',
    'min': 1,
    'max': 99,
    'value': 0,
        'stop': function(event, ui) {
            var value = $(".dimmer_<%= dimmer.uid %>").slider("value");
            $(".dimmer_value_<%= dimmer.uid %>").val(value);
            var form = $(this).parents('form:first');
           
            form.submit();
          
            

        }
};
$('.dimmer_<%= dimmer.uid %>').slider(colorful_sliders_options);




<% end %>
</script>


   

